<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="format-detection" content="telephone=no,email=no,address=no" />
  <title>å…ƒæ—¦ç¥ç¦ï½œæŸ¯å½±æ•°æ™º</title>
  <style>
    :root{
      --bg1:#0b0b12; --bg2:#1a0f12;
      --gold:#f6d57a; --gold2:#ffefb5;
      --red:#ff3b3b; --text:#f5f5f7;
      --muted:rgba(245,245,247,.72);
      --border:rgba(255,255,255,.14);
      --shadow:0 24px 80px rgba(0,0,0,.55);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; overflow:hidden; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 900px at 20% 10%, rgba(255,210,120,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 30%, rgba(255,70,70,.12), transparent 65%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    body:before{
      content:"";
      position:fixed;inset:-20%;
      background:
        radial-gradient(600px 420px at 20% 30%, rgba(246,213,122,.14), transparent 60%),
        radial-gradient(520px 360px at 80% 65%, rgba(255,80,80,.12), transparent 62%),
        radial-gradient(420px 320px at 55% 10%, rgba(122,231,255,.10), transparent 60%);
      opacity:.55;
      filter:blur(18px);
      animation:bgDrift 18s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes bgDrift{
      0%,100%{transform:translate3d(0,0,0)}
      50%{transform:translate3d(-3%,2%,0)}
    }
    #fx{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;opacity:.9}
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:24px 16px}
    .card{
      width:92vw; max-width:420px;
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden; position:relative;
      --float:0px;
      --rx:0deg;
      --ry:0deg;
      transform:translateY(var(--float)) rotateX(var(--rx)) rotateY(var(--ry));
      transform-style:preserve-3d;
      animation:cardFloat 6.2s ease-in-out infinite;
      will-change:transform;
    }
    .card:after{
      content:"é©¬";
      position:absolute;
      right:16px;
      bottom:74px;
      font-weight:900;
      font-size:118px;
      line-height:1;
      letter-spacing:0;
      color:rgba(246,213,122,.085);
      transform:rotate(-12deg);
      pointer-events:none;
      filter:blur(.2px);
    }
    @keyframes cardFloat{
      0%,100%{--float:0px}
      50%{--float:-10px}
    }
    .topGlow{
      position:absolute;left:-80px;right:-80px;top:-120px;height:220px;
      background:radial-gradient(circle at 50% 60%, rgba(246,213,122,.42), transparent 65%);
      filter:blur(6px);opacity:.9
    }
    .header{padding:22px 20px 10px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;min-width:0}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(246,213,122,.95), rgba(255,239,181,.55));
      box-shadow:0 10px 24px rgba(246,213,122,.22)
    }
    .brandTxt .name{font-weight:700;font-size:15px;line-height:1.1}
    .brandTxt .sub{font-size:12px;color:var(--muted);margin-top:4px}
    .badge{
      font-size:12px;padding:7px 10px;border-radius:999px;
      border:1px solid rgba(246,213,122,.35);
      background:rgba(246,213,122,.10);
      color:var(--gold2);white-space:nowrap
    }
    .right{display:flex;align-items:center;gap:10px}
    .iconBtn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
      border-radius:12px;
      padding:9px 10px;
      font-size:12px;
      cursor:pointer;
      line-height:1;
      -webkit-tap-highlight-color:transparent;
      user-select:none
    }
    .iconBtn:active{transform:translateY(1px)}
    .iconBtn.on{
      border-color:rgba(246,213,122,.38);
      background:rgba(246,213,122,.12);
      color:var(--gold2)
    }
    .hero{padding:6px 20px 10px}
    .year{
      display:flex;align-items:baseline;gap:10px;
      font-size:44px;font-weight:900;letter-spacing:1px;margin:6px 0 6px;
      background:linear-gradient(180deg, var(--gold2), var(--gold));
      -webkit-background-clip:text;background-clip:text;color:transparent
    }
    .year .y{display:inline-block;transform-origin:50% 100%;transition:transform .55s ease, opacity .55s ease, filter .55s ease}
    .year .arrow{
      display:inline-block;
      opacity:.55;
      transform:translateY(-2px);
      transition:opacity .55s ease, transform .55s ease;
      -webkit-text-stroke:0;
    }
    .year .y2025{opacity:.82;filter:saturate(.95) brightness(.95)}
    .year .y2026{opacity:.98;filter:saturate(1.05) brightness(1.02)}
    .year.shift .y2025{opacity:.28;transform:translateY(6px) scale(.92);filter:saturate(.85) brightness(.85)}
    .year.shift .arrow{opacity:.92;transform:translateY(-6px) scale(1.03)}
    .year.shift .y2026{transform:translateY(-4px) scale(1.06);filter:saturate(1.12) brightness(1.08)}
    .yearSub{
      font-size:12px;
      color:rgba(255,255,255,.74);
      letter-spacing:.6px;
      display:flex;align-items:center;gap:8px;
      margin:0 0 10px;
    }
    .horseTag{
      font-weight:900;
      color:rgba(255,255,255,.86);
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(246,213,122,.22);
      background:rgba(246,213,122,.08)
    }
    .title{font-size:20px;font-weight:800;margin:0 0 10px;letter-spacing:.6px}
    .hint{font-size:13px;color:rgba(255,255,255,.78);display:flex;align-items:center;gap:8px;opacity:.9}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--red);box-shadow:0 0 0 6px rgba(255,59,59,.14)}
    .divider{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);margin:14px 0}
    .content{padding:4px 20px 18px}
    .slide{min-height:160px;display:none;position:relative}
    .slide.active{display:block}
    .slide.enter{animation:slideIn .38s ease both}
    @keyframes slideIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .p{font-size:15px;line-height:1.75;color:rgba(255,255,255,.92);margin:0 0 10px}
    .p strong{color:var(--gold2);font-weight:800}
    .p.meta{font-size:13px;color:rgba(255,255,255,.78)}
    .signature{margin-top:10px;display:flex;align-items:flex-end;justify-content:space-between;gap:14px}
    .signLeft,.signRight{font-size:13px;color:var(--muted);line-height:1.55}
    .signRight{text-align:right;white-space:nowrap}
    .stamp{
      position:absolute;
      right:18px;bottom:86px;
      padding:10px 14px;
      border:2px solid rgba(246,213,122,.7);
      border-radius:12px;
      color:rgba(246,213,122,.95);
      font-weight:900;
      letter-spacing:2px;
      transform:rotate(-12deg) scale(.6);
      opacity:0;
      filter:drop-shadow(0 10px 20px rgba(246,213,122,.25));
      background:rgba(246,213,122,.06);
    }
    .stamp.show{animation:stampIn .5s ease-out forwards}
    @keyframes stampIn{
      to{transform:rotate(-12deg) scale(1);opacity:1}
    }
    .shareRow{
      display:flex;
      gap:10px;
      margin:6px 0 8px;
    }
    .shareRow .btn{
      flex:1;
    }
    .qr{
      margin-top:10px;
      display:flex;
      justify-content:center;
    }
    .qr img{
      width:132px;height:132px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      user-select:none;
      -webkit-user-drag:none;
    }
    .footer{
      padding:14px 20px 18px;
      background:linear-gradient(180deg, transparent, rgba(0,0,0,.18));
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .btn{
      border:0;padding:12px 14px;border-radius:14px;
      font-weight:700;font-size:14px;cursor:pointer;
      color:#1a1208;
      background:linear-gradient(180deg, var(--gold2), var(--gold));
      box-shadow:0 16px 34px rgba(246,213,122,.18)
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;font-weight:600
    }
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;border-radius:12px;font-size:13px;
      opacity:0;pointer-events:none;
      transition:opacity .25s ease;max-width:92vw;text-align:center
    }
    .toast.show{opacity:1}
    .ripple{
      position:absolute;border-radius:999px;
      background:radial-gradient(circle, rgba(246,213,122,.45), transparent 62%);
      transform:scale(.2);
      animation:ripple .65s ease-out forwards;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    @keyframes ripple{
      to{transform:scale(2.6);opacity:0}
    }

    .stage{
      position:fixed;inset:0;z-index:20;
      display:flex;align-items:center;justify-content:center;
      padding:26px 16px;
      background:
        radial-gradient(1000px 720px at 50% 18%, rgba(246,213,122,.14), transparent 60%),
        radial-gradient(1000px 720px at 50% 70%, rgba(255,59,59,.10), transparent 60%),
        linear-gradient(180deg, rgba(8,8,14,.88), rgba(12,10,18,.78));
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
    }
    .countdown{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      font-size:64px;font-weight:900;
      color:var(--gold2);
      opacity:0;pointer-events:none;
      text-shadow:0 12px 26px rgba(246,213,122,.25);
    }
    .countdown.show{opacity:1;transition:opacity .2s ease}
    .countdown.pop{animation:countPop .35s ease both}
    @keyframes countPop{
      from{transform:scale(.8);opacity:.6}
      to{transform:scale(1);opacity:1}
    }
    .stage.hide{opacity:0;pointer-events:none;transition:opacity .5s ease}
    .envelope{
      width:min(420px, 92vw);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      padding:22px 20px 18px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .envelope:before{
      content:"";
      position:absolute;left:-120px;right:-120px;top:-140px;height:260px;
      background:radial-gradient(circle at 50% 60%, rgba(246,213,122,.35), transparent 66%);
      filter:blur(7px);
      opacity:.95
    }
    .stageTitle{
      position:relative;
      font-weight:900;
      letter-spacing:1.2px;
      font-size:18px;
      margin:8px 0 6px;
      background:linear-gradient(180deg, var(--gold2), var(--gold));
      -webkit-background-clip:text;background-clip:text;color:transparent
    }
    .stageTitle .horse{opacity:.95;margin-right:6px}
    .stageHint{position:relative;color:rgba(255,255,255,.78);font-size:13px;line-height:1.55;margin:0 0 14px}
    .seal{
      position:relative;
      width:68px;height:68px;margin:0 auto 10px;
      border-radius:22px;
      display:grid;place-items:center;
      color:#1a1208;
      font-weight:900;
      letter-spacing:1px;
      background:linear-gradient(180deg, var(--gold2), var(--gold));
      box-shadow:0 20px 40px rgba(246,213,122,.18);
      transform:rotate(-2deg);
      user-select:none
    }
    .stageBtn{
      position:relative;
      width:100%;
      border:0;
      border-radius:16px;
      padding:14px 14px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      color:#1a1208;
      background:linear-gradient(180deg, var(--gold2), var(--gold));
      box-shadow:0 16px 34px rgba(246,213,122,.18);
      -webkit-tap-highlight-color:transparent;
    }
    .stageBtn:active{transform:translateY(1px)}
    .stageNote{position:relative;margin-top:10px;font-size:12px;color:rgba(255,255,255,.70);line-height:1.45}

    @media (prefers-reduced-motion: reduce){
      body{overflow:auto}
      body:before{animation:none}
      #fx{display:none}
      .card{animation:none}
      .slide.enter{animation:none}
      .iconBtn:active,.stageBtn:active{transform:none}
    }
    @media (max-width: 520px){
      #btnPrev{display:none}
      #btnNext{flex:1}
      #pageInfo{min-width:60px;text-align:center}
      .footer{justify-content:flex-end}
    }
  </style>
</head>
<body>

<canvas id="fx"></canvas>

<audio id="bgm" preload="auto" playsinline loop>
  <source src="assest/music.wav" type="audio/wav" />
</audio>

<div class="stage" id="stage">
  <div class="countdown" id="countdown" aria-hidden="true">3</div>
  <div class="envelope" role="dialog" aria-modal="true" aria-label="æ‰“å¼€æ–°å¹´è´ºå¡">
    <div class="seal" aria-hidden="true">æ‹†å°</div>
    <div class="stageTitle"><span class="horse" aria-hidden="true">ğŸ</span>é©¬å¹´å…ƒæ—¦è´ºå¡</div>
    <div class="stageHint">ä» 2025 è¿ˆå‘ 2026 Â· è½»è§¦æŒ‰é’®å¼€å¯ï¼ˆå»ºè®®æ‰“å¼€éŸ³ä¹æ›´æœ‰æ°›å›´ï¼‰</div>
    <button class="stageBtn" id="btnOpen" type="button">ç‚¹å‡»æ‹†å°</button>
    <div class="stageNote">æ‰“å¼€åå¯ç¿»é¡µï¼Œæœ€åä¸€é¡µæœ‰å½©è›‹ã€‚</div>
  </div>
</div>

<div class="wrap">
  <div class="card" id="card">
    <div class="topGlow"></div>

    <div class="header">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandTxt">
          <div class="name">æŸ¯å½±æ•°æ™º</div>
          <div class="sub">To our clients & supporters</div>
        </div>
      </div>
      <div class="right">
        <div class="badge">é©¬å¹´ä¸»é¢˜ Â· 2026</div>
        <button class="iconBtn" id="btnSound" type="button" aria-label="å£°éŸ³">å£°</button>
        <button class="iconBtn" id="btnShare" type="button" aria-label="å¤åˆ¶ç¥ç¦é“¾æ¥">é“¾</button>
      </div>
    </div>

    <div class="hero">
      <div class="year" id="year">
        <span class="y y2025" id="yFrom">2025</span>
        <span class="arrow" aria-hidden="true">â†’</span>
        <span class="y y2026" id="yTo">2026</span>
      </div>
      <div class="yearSub"><span class="horseTag">é©¬å¹´</span><span>å¥”å‘æ–°ç¨‹ Â· é©¬åˆ°æˆåŠŸ</span></div>
      <h1 class="title" id="mainTitle">å…ƒæ—¦å¿«ä¹ï½œé©¬åˆ°æˆåŠŸ</h1>
      <div class="hint"><span class="dot"></span><span>è½»è§¦ç»§ç»­ Â· æ¯ä¸€ä¸‹éƒ½æ˜¯ä¸€æ®µç¥ç¦</span></div>
      <div class="divider"></div>
    </div>

    <div class="content">
      <div class="slide active">
        <p class="p">äº²çˆ±çš„ <strong id="toName">å°Šæ•¬çš„æœ‹å‹</strong>ï¼š</p>
        <p class="p meta">èº«ä»½ï¼š<strong id="companyName">å­¦ç”Ÿ/åœ¨èŒ/ä¼ä¸š/ä¸ªä½“</strong> Â· æ–¹å‘ï¼š<strong id="projectName">å­¦ä¸š/äº‹ä¸š/ç»è¥</strong></p>
        <p class="p">æ„Ÿè°¢è¿‡å» <strong id="coYears">1</strong> å¹´é‡Œï¼Œæ‚¨å¯¹ <strong>æŸ¯å½±æ•°æ™º</strong> çš„ä¿¡ä»»ä¸æ”¯æŒã€‚</p>
        <p class="p">è¿™ä¸€ä»½æ”¯æŒï¼Œæˆ‘ä»¬å§‹ç»ˆé“­è®°åœ¨å¿ƒã€‚</p>
        <p class="p">æ–°çš„ä¸€å¹´ï¼ŒæŠŠç¥æ„¿é€ä¸Šã€‚</p>
      </div>

      <div class="slide">
        <p class="p">æ„¿æ‚¨æ— è®ºæ˜¯å­¦ç”Ÿã€åœ¨èŒä¼™ä¼´ã€ä¼ä¸šå®¢æˆ·ï¼Œè¿˜æ˜¯ä¸ªä½“ç»è¥è€…ï¼š</p>
        <p class="p"><strong>é©¬åˆ°æˆåŠŸ</strong>ï¼Œæ‰€è¡Œçš†å¦é€”ã€‚</p>
        <p class="p"><strong>é¡¹ç›®æ›´é¡º</strong>ï¼Œåˆä½œæ›´ç¨³ï¼Œè¿›å±•æ›´å¿«ã€‚</p>
        <p class="p"><strong>å¿ƒæ„¿çš†è¾¾</strong>ï¼ŒæŠŠæ¯ä¸€ä¸ªç›®æ ‡éƒ½è·‘æˆâ€œç»“æœâ€ã€‚</p>
        <p class="p">ä¹Ÿæ„¿æˆ‘ä»¬ç»§ç»­å¹¶è‚©å‘å‰ï¼ŒæŠŠæ¯ä¸€æ¬¡äº¤ä»˜ï¼Œéƒ½åšæˆå€¼å¾—å›å¿†çš„ä½œå“ã€‚</p>
      </div>

      <div class="slide">
        <p class="p">æŠŠç¥ç¦å¤šè·‘ä¸€ç¨‹ï¼Œä¹Ÿè®©å¥½è¿å¤šæ¥ä¸€ç‚¹ âœ¨</p>
        <div class="signature">
          <div class="signLeft">
            <div>ç¥æ‚¨æ–°å¹´ï¼š</div>
            <div><strong>å–œä¹å¸¸ä¼´ Â· ä¸‡äº‹é¡ºæ„</strong></div>
          </div>
          <div class="signRight">
            <div id="fromName">æŸ¯å½±æ•°æ™º æ•¬ä¸Š</div>
            <div id="today">2025.12.24</div>
          </div>
        </div>
        <div class="stamp" id="stamp">å·²ç­¾æ”¶ç¥ç¦</div>
        <div class="shareRow">
        </div>
        <div class="divider"></div>
        <div class="qr">
          <img src="assest/å¾®ä¿¡æœåŠ¡å·.png" alt="å¾®ä¿¡æœåŠ¡å·äºŒç»´ç " />
        </div>
        <div class="small" style="text-align:center;margin-top:10px">é•¿æŒ‰è¯†åˆ«ï¼Œå…³æ³¨æœåŠ¡å·</div>
      </div>
    </div>

    <div class="footer">
      <button class="btn ghost" id="btnPrev">ä¸Šä¸€é¡µ</button>
      <div class="small" id="pageInfo">1 / 3</div>
      <button class="btn" id="btnNext">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">æç¤º</div>

<script>
  // === ä½ åªæ”¹è¿™é‡Œ ===
  var CONFIG = {
    title: "å…ƒæ—¦å¿«ä¹ï½œé©¬åˆ°æˆåŠŸ",
    toName: "å°Šæ•¬çš„å®¢æˆ·",
    fromName: "æŸ¯å½±æ•°æ™º æ•¬ä¸Š",
    companyName: "å­¦ç”Ÿ/åœ¨èŒ/ä¼ä¸š/ä¸ªä½“",
    projectName: "å­¦ä¸š/äº‹ä¸š/ç»è¥",
    coYears: "1",
    shareTag: "KY2026"
  };

  function applyConfig(){
    document.getElementById("mainTitle").textContent = CONFIG.title;
    document.getElementById("toName").textContent = CONFIG.toName;
    document.getElementById("fromName").textContent = CONFIG.fromName;
    document.getElementById("companyName").textContent = CONFIG.companyName;
    document.getElementById("projectName").textContent = CONFIG.projectName;
    document.getElementById("coYears").textContent = CONFIG.coYears;
  }

  // URL å‚æ•°ä¸ªæ€§åŒ–ï¼š?to=xxx&from=xxx&title=xxx&company=xxx&project=xxx&years=1
  (function(){
    try{
      var qs = new URLSearchParams(location.search);
      if(qs.get("title")) CONFIG.title = qs.get("title");
      if(qs.get("to")) CONFIG.toName = qs.get("to");
      if(qs.get("from")) CONFIG.fromName = qs.get("from");
      if(qs.get("company")) CONFIG.companyName = qs.get("company");
      if(qs.get("project")) CONFIG.projectName = qs.get("project");
      if(qs.get("years")) CONFIG.coYears = qs.get("years");
    }catch(e){}
  })();
  applyConfig();

  var d = new Date();
  var y = d.getFullYear();
  var m = ("0" + (d.getMonth() + 1)).slice(-2);
  var da = ("0" + d.getDate()).slice(-2);
  document.getElementById("today").textContent = y + "." + m + "." + da;

  var prefersReduce = false;
  try{ prefersReduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches; }catch(e){}

  // å¼€åœºâ€œæ‹†å°â€
  var opened = false;
  var stage = document.getElementById("stage");
  var btnOpen = document.getElementById("btnOpen");
  var countdown = document.getElementById("countdown");
  var yearEl = document.getElementById("year");
  var countdownActive = false;

  // ç¿»é¡µ
  var slides = document.querySelectorAll(".slide");
  var pageInfo = document.getElementById("pageInfo");
  var btnNext = document.getElementById("btnNext");
  var btnPrev = document.getElementById("btnPrev");
  var idx = 0;
  var stamped = false;

  function render(){
    for(var i=0;i<slides.length;i++){
      slides[i].className = "slide" + (i===idx ? " active" : "");
    }
    var active = slides[idx];
    if(active){
      active.classList.remove("enter");
      void active.offsetWidth;
      active.classList.add("enter");
    }
    pageInfo.innerHTML = (idx+1) + " / " + slides.length;
    btnPrev.disabled = (idx===0);
    btnNext.innerHTML = (idx===slides.length-1) ? "å®Œæˆ" : "ä¸‹ä¸€é¡µ";
    if(idx === slides.length-1 && !stamped){
      stamped = true;
      var stamp = document.getElementById("stamp");
      if(stamp) stamp.classList.add("show");
      burstAtCard(12, true);
    }
  }

  function showToast(msg){
    var toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.className = "toast show";
    setTimeout(function(){ toast.className = "toast"; }, 1600);
  }

  // å£°éŸ³ï¼ˆWebAudioï¼šæ— éœ€å¤–é“¾éŸ³é¢‘ï¼‰
  var btnSound = document.getElementById("btnSound");
  var soundOn = true;
  var soundPrefSet = false;
  var audioCtx = null;
  var bgm = document.getElementById("bgm");
  if(bgm) bgm.volume = 0.55;

  // å¦‚åªè¦â€œå‰¯æ­Œç‰‡æ®µå¾ªç¯â€ï¼ŒæŠŠ end è®¾ç½®ä¸ºå‰¯æ­Œç»“æŸç§’æ•°ï¼ˆ> startï¼‰ã€‚
  var MUSIC = { start: 0, end: 0 };

  function applyMusicSegment(){
    if(!bgm) return;
    if(MUSIC.end > MUSIC.start && isFinite(MUSIC.start) && isFinite(MUSIC.end)){
      try{ bgm.loop = false; }catch(e){}
      bgm.ontimeupdate = function(){
        if(bgm.currentTime >= MUSIC.end){
          bgm.currentTime = MUSIC.start;
          var p = bgm.play();
          if(p && p.catch) p.catch(function(){});
        }
      };
    }else{
      try{ bgm.loop = true; }catch(e){}
      bgm.ontimeupdate = null;
    }
  }
  applyMusicSegment();

  function startBgm(){
    if(!bgm) return;
    try{ if(bgm.readyState < 2) bgm.load(); }catch(e){}
    if(MUSIC.end > MUSIC.start){
      try{ if(bgm.currentTime < MUSIC.start || bgm.currentTime > MUSIC.end) bgm.currentTime = MUSIC.start; }catch(e){}
    }
    var p = bgm.play();
    if(p && p.catch) p.catch(function(){});
  }
  function stopBgm(){
    if(!bgm) return;
    try{ bgm.pause(); }catch(e){}
  }

  function syncSoundBtn(){
    btnSound.className = "iconBtn" + (soundOn ? " on" : "");
    btnSound.textContent = soundOn ? "ä¹" : "é™";
  }
  function loadSoundPref(){
    try{
      var v = localStorage.getItem("nyc_sound");
      soundPrefSet = v !== null;
      if(v === null){
        soundOn = true;
      }else{
        soundOn = v === "1";
      }
    }catch(e){
      soundOn = true;
      soundPrefSet = false;
    }
    syncSoundBtn();
  }
  function saveSoundPref(){
    try{ localStorage.setItem("nyc_sound", soundOn ? "1" : "0"); }catch(e){}
  }
  function ensureAudio(){
    if(audioCtx) return;
    try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }catch(e){ audioCtx = null; }
    try{
      if(audioCtx && audioCtx.state === "suspended" && audioCtx.resume) audioCtx.resume();
    }catch(e){}
  }
  function playChime(kind){
    if(!soundOn || !audioCtx || prefersReduce) return;
    try{
      if(audioCtx.state === "suspended" && audioCtx.resume) audioCtx.resume();
    }catch(e){}
    var t0 = audioCtx.currentTime;
    var master = audioCtx.createGain();
    master.gain.value = 0.0001;
    master.connect(audioCtx.destination);
    master.gain.setTargetAtTime(0.22, t0, 0.02);
    master.gain.setTargetAtTime(0.0001, t0 + 0.55, 0.08);

    function tone(freq, start, dur){
      var o = audioCtx.createOscillator();
      var g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(master);
      g.gain.setTargetAtTime(0.16, start, 0.01);
      g.gain.setTargetAtTime(0.0001, start + dur, 0.05);
      o.start(start);
      o.stop(start + dur + 0.2);
    }

    if(kind === "tick"){
      tone(880, t0 + 0.00, 0.08);
    }else if(kind === "open"){
      tone(523.25, t0 + 0.00, 0.18);
      tone(659.25, t0 + 0.06, 0.22);
      tone(783.99, t0 + 0.12, 0.26);
    }else if(kind === "flip"){
      tone(659.25, t0 + 0.00, 0.12);
      tone(783.99, t0 + 0.05, 0.14);
    }else{
      tone(523.25, t0 + 0.00, 0.14);
      tone(659.25, t0 + 0.05, 0.16);
      tone(523.25, t0 + 0.10, 0.16);
    }
  }

  btnSound.onclick = function(){
    ensureAudio();
    soundOn = !soundOn;
    saveSoundPref();
    syncSoundBtn();
    if(soundOn){
      showToast("å·²å¼€å¯éŸ³ä¹");
      startBgm();
    }else{
      showToast("å·²å…³é—­éŸ³ä¹");
      stopBgm();
    }
    playChime("flip");
  };
  loadSoundPref();
  if(bgm){
    bgm.addEventListener("error", function(){
      showToast("éŸ³ä¹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åæˆ–æ ¼å¼");
    });
  }

  function getShareId(){
    var tag = CONFIG.shareTag || "KY2026";
    try{
      var sid = localStorage.getItem("nyc_sid");
      if(!sid){
        sid = tag + "-" + Date.now().toString(36).slice(-6) + Math.random().toString(36).slice(2,6);
        localStorage.setItem("nyc_sid", sid);
      }
      return sid;
    }catch(e){
      return tag + "-" + Date.now().toString(36).slice(-6);
    }
  }

  // å¤åˆ¶é“¾æ¥ï¼ˆæŠŠç¥ç¦å¸¦èµ°ï¼‰
  var btnShare = document.getElementById("btnShare");
  btnShare.onclick = function(){
    try{
      var qs = new URLSearchParams();
      qs.set("title", CONFIG.title);
      qs.set("to", CONFIG.toName);
      qs.set("from", CONFIG.fromName);
      qs.set("company", CONFIG.companyName);
      qs.set("project", CONFIG.projectName);
      qs.set("years", CONFIG.coYears);
      qs.set("sid", getShareId());
      qs.set("utm_source", "card");
      qs.set("utm_medium", "share");
      qs.set("utm_campaign", "newyear2026");
      var u = new URL(location.href);
      u.search = qs.toString();
      var url = u.toString();
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(url).then(function(){
          showToast("ç¥ç¦é“¾æ¥å·²å¤åˆ¶");
          burstAtCard(10, true);
        }).catch(function(){
          window.prompt("å¤åˆ¶è¿™æ¡é“¾æ¥å‘é€ç»™å¯¹æ–¹ï¼š", url);
        });
      }else{
        window.prompt("å¤åˆ¶è¿™æ¡é“¾æ¥å‘é€ç»™å¯¹æ–¹ï¼š", url);
      }
    }catch(e){
      showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶åœ°å€æ é“¾æ¥");
    }
  };

  btnNext.onclick = function(){
    if(!opened){ showToast("å…ˆç‚¹â€œæ‹†å°â€å†ç»§ç»­"); return; }
    if(idx < slides.length-1){ idx++; render(); }
    else{
      showToast("ç¥ç¦å·²é€è¾¾ï¼šå…ƒæ—¦å¿«ä¹ï¼Œé©¬åˆ°æˆåŠŸï¼");
      finale();
    }
    playChime("flip");
    burstAtCard(6, false);
  };
  btnPrev.onclick = function(){
    if(!opened){ showToast("å…ˆç‚¹â€œæ‹†å°â€å†ç»§ç»­"); return; }
    if(idx > 0){ idx--; render(); }
    playChime("flip");
    burstAtCard(4, false);
  };

  // ç‚¹å‡»å¡ç‰‡ç©ºç™½åŒºåŸŸä¹Ÿç¿»é¡µ
  document.getElementById("card").onclick = function(e){
    var t = e.target || e.srcElement;
    if(t && t.tagName && t.tagName.toLowerCase() === "button") return;
    btnNext.onclick();
  };

  function doOpen(){
    if(opened) return;
    opened = true;
    ensureAudio();
    playChime("open");
    stage.className = "stage hide";
    setTimeout(function(){ stage.style.display = "none"; }, 650);
    openingFireworks();
    burstAtCard(18, true);
    if(yearEl){
      if(prefersReduce) yearEl.classList.add("shift");
      else setTimeout(function(){ yearEl.classList.add("shift"); }, 260);
    }
    if(!soundPrefSet){
      soundOn = true;
      saveSoundPref();
      syncSoundBtn();
    }
    if(soundOn) startBgm();
    showToast("æ‹†å°æˆåŠŸï¼šè½»è§¦ç»§ç»­");
  }

  function startCountdown(){
    if(opened || countdownActive) return;
    if(prefersReduce){ doOpen(); return; }
    countdownActive = true;
    var n = 3;
    if(countdown){
      countdown.textContent = n;
      countdown.classList.add("show");
      countdown.classList.remove("pop");
      void countdown.offsetWidth;
      countdown.classList.add("pop");
    }
    ensureAudio();
    playChime("tick");
    var timer = setInterval(function(){
      n--;
      playChime("tick");
      if(n <= 0){
        clearInterval(timer);
        countdownActive = false;
        if(countdown) countdown.classList.remove("show");
        doOpen();
      }else if(countdown){
        countdown.textContent = n;
        countdown.classList.remove("pop");
        void countdown.offsetWidth;
        countdown.classList.add("pop");
      }
    }, 1000);
  }

  btnOpen.onclick = function(){
    startCountdown();
  };

  // é‡‘ç²‰ç²’å­ + å½©è›‹çƒŸèŠ±ï¼ˆä¿å®ˆå®ç°ï¼‰
  var canvas = document.getElementById("fx");
  var ctx = canvas.getContext("2d");
  var DPR = Math.min(2, window.devicePixelRatio || 1);
  var W=0,H=0;
  function resize(){
    W = canvas.width = Math.floor(window.innerWidth * DPR);
    H = canvas.height = Math.floor(window.innerHeight * DPR);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
  }
  window.addEventListener("resize", resize);
  resize();

  function rand(a,b){ return a + Math.random()*(b-a); }

  var dust = [];
  var sparks = [];
  var N = 90;
  (function(){
    var area = Math.max(1, window.innerWidth * window.innerHeight);
    N = Math.round(Math.min(140, Math.max(60, area / 12000)));
    if(prefersReduce) N = 0;
  })();
  for(var i=0;i<N;i++){
    dust.push({
      x: rand(0,W), y: rand(0,H),
      r: rand(0.8, 2.4) * DPR,
      vy: rand(0.15, 0.85) * DPR,
      vx: rand(-0.2, 0.2) * DPR,
      a: rand(0.25, 0.85)
    });
  }

  function cardCenter(){
    var el = document.getElementById("card");
    var r = el.getBoundingClientRect();
    return {
      x: (r.left + r.width/2) * DPR,
      y: (r.top + r.height/2) * DPR
    };
  }

  function burst(x, y, count, strong){
    if(prefersReduce) return;
    var colors = ["#f6d57a","#ff4f4f","#ffefb5","#7ae7ff","#f7a7ff"];
    var n = Math.max(6, Math.min(60, count|0));
    for(var i=0;i<n;i++){
      var a = Math.random() * Math.PI * 2;
      var sp = rand(1.2, strong ? 6.5 : 4.6) * DPR;
      sparks.push({
        x:x, y:y,
        vx: Math.cos(a) * sp,
        vy: Math.sin(a) * sp - rand(0.2, 1.5) * DPR,
        r: rand(1.0, 2.6) * DPR,
        ttl: strong ? rand(42, 70) : rand(30, 54),
        life: 0,
        c: colors[(Math.random()*colors.length)|0]
      });
    }
  }

  function burstAtCard(count, strong){
    try{
      var c = cardCenter();
      burst(c.x, c.y - 20*DPR, count, strong);
    }catch(e){}
  }

  function burstScreen(count){
    if(prefersReduce) return;
    var x = rand(80*DPR, (window.innerWidth-80) * DPR);
    var y = rand(80*DPR, (window.innerHeight*0.6) * DPR);
    burst(x, y, count, true);
  }

  function openingFireworks(){
    if(prefersReduce) return;
    var loops = 0;
    var timer = setInterval(function(){
      loops++;
      burstScreen(24);
      if(loops >= 8) clearInterval(timer);
    }, 180);
  }

  function finale(){
    if(prefersReduce) return;
    var loops = 0;
    var timer = setInterval(function(){
      loops++;
      var c = cardCenter();
      burst(c.x + rand(-80,80)*DPR, c.y + rand(-90,40)*DPR, 22, true);
      if(loops >= 6) clearInterval(timer);
    }, 260);
    playChime("finale");
  }

  var running = true;
  document.addEventListener("visibilitychange", function(){
    running = !document.hidden;
    if(document.hidden){
      stopBgm();
    }else{
      if(opened && soundOn) startBgm();
    }
  });

  // è§¦æ„Ÿä¸æ¶Ÿæ¼ª
  function haptic(){
    try{ if(navigator.vibrate) navigator.vibrate(12); }catch(e){}
  }
  function rippleAt(e){
    var card = document.getElementById("card");
    if(!card || prefersReduce) return;
    var r = card.getBoundingClientRect();
    var x = (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX) || (r.left + r.width/2)) - r.left;
    var y = (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY) || (r.top + r.height/2)) - r.top;
    var el = document.createElement("span");
    el.className = "ripple";
    el.style.left = (x - 10) + "px";
    el.style.top = (y - 10) + "px";
    el.style.width = "20px";
    el.style.height = "20px";
    card.appendChild(el);
    setTimeout(function(){ if(el && el.parentNode) el.parentNode.removeChild(el); }, 700);
  }

  // è§¦æ‘¸æ»‘åŠ¨ç¿»é¡µï¼ˆç§»åŠ¨ç«¯ï¼‰
  (function(){
    var card = document.getElementById("card");
    if(!card) return;
    var sx=0, sy=0, moving=false;
    card.addEventListener("touchstart", function(e){
      if(!opened) return;
      var t = e.touches[0];
      sx = t.clientX; sy = t.clientY; moving = true;
    }, {passive:true});
    card.addEventListener("touchend", function(e){
      if(!moving) return;
      var t = (e.changedTouches && e.changedTouches[0]) || {clientX:sx, clientY:sy};
      var dx = t.clientX - sx;
      var dy = t.clientY - sy;
      moving = false;
      if(Math.abs(dx) > 42 && Math.abs(dx) > Math.abs(dy)){
        if(dx < 0) btnNext.onclick();
        else btnPrev.onclick();
        haptic();
        rippleAt(e);
      }
    });
  })();

  // è½»å¾®è·Ÿéšï¼ˆæ¡Œé¢ç«¯ï¼‰
  (function(){
    var card = document.getElementById("card");
    if(!card) return;
    card.addEventListener("pointermove", function(e){
      if(e.pointerType === "touch" || prefersReduce) return;
      var r = card.getBoundingClientRect();
      var cx = r.left + r.width/2;
      var cy = r.top + r.height/2;
      var dx = (e.clientX - cx) / r.width;
      var dy = (e.clientY - cy) / r.height;
      card.style.setProperty("--ry", (dx * 6).toFixed(2) + "deg");
      card.style.setProperty("--rx", (-dy * 6).toFixed(2) + "deg");
    });
    card.addEventListener("pointerleave", function(){
      card.style.setProperty("--rx","0deg");
      card.style.setProperty("--ry","0deg");
    });
  })();

  function tick(){
    if(!running){ requestAnimationFrame(tick); return; }
    ctx.clearRect(0,0,W,H);
    for(var i=0;i<dust.length;i++){
      var p = dust[i];
      p.y += p.vy; p.x += p.vx;
      if(p.y > H + 20*DPR){ p.y = -20*DPR; p.x = rand(0,W); }
      if(p.x < -20*DPR) p.x = W + 20*DPR;
      if(p.x > W + 20*DPR) p.x = -20*DPR;

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = "rgba(246,213,122," + p.a + ")";
      ctx.fill();
    }

    // sparks
    if(sparks.length){
      for(var j=sparks.length-1;j>=0;j--){
        var s = sparks[j];
        s.life += 1;
        s.vy += 0.035 * DPR;
        s.x += s.vx;
        s.y += s.vy;
        var k = 1 - (s.life / s.ttl);
        if(k <= 0){ sparks.splice(j, 1); continue; }
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = s.c;
        ctx.globalAlpha = Math.min(1, Math.max(0, k));
        ctx.fill();
        ctx.globalAlpha = 1;
      }
    }
    requestAnimationFrame(tick);
  }
  tick();

  render();
</script>

</body>
</html>
